import { Button, Select, Stack, Switch, TextInput, Alert } from "@mantine/core";
import { useForm } from "@mantine/form";
import { useCallback, useState, useEffect, useRef } from "react";
import { CommandHelper } from "../../utils/CommandHelper";
import ConsoleWrapper from "../ConsoleWrapper/ConsoleWrapperWithBuiltinOverlay";
import { RenderComponent } from "../UserGuide/UserGuide";
import { SaveOutputToTextFile_v2 } from "../SaveOutputToFile/SaveOutputToTextFile";
import { LoadingOverlayAndCancelButton } from "../OverlayAndCancelButton/OverlayAndCancelButton";
import { checkAllCommandsAvailability } from "../../utils/CommandAvailability";
import InstallationModal from "../InstallationModal/InstallationModal";

interface FormValuesType {
    plugin: string;
    target: string;
    port: string;
    email: string;
    username: string;
    password: string;
}

export function BEDTool() {
    const [loading, setLoading] = useState(false);
    const [pid, setPid] = useState("");
    const [output, setOutput] = useState("");
    const [selectedPlugin, setSelectedPlugin] = useState("");
    const [allowSave, setAllowSave] = useState(false);
    const [hasSaved, setHasSaved] = useState(false);
    const [customConfig, setCustomConfig] = useState(false);
    const [isCommandAvailable, setIsCommandAvailable] = useState(false);
    const [opened, setOpened] = useState(!isCommandAvailable);
    const [loadingModal, setLoadingModal] = useState(true);
    const [showAlert, setShowAlert] = useState(true);
    const alertTimeout = useRef<NodeJS.Timeout | null>(null);

    const dependencies = ["bed"];
    const pluginList = ["FTP", "SMTP", "POP", "HTTP", "IRC", "IMAP", "PJL", "LPD", "FINGER", "SOCKS4"];
    const pluginsRequiringAuth = ["FTP", "IMAP", "POP"];
    const pluginRequiringEmail = ["SMTP"];

    const form = useForm<FormValuesType>({
        initialValues: {
            plugin: "",
            target: "",
            port: "",
            email: "",
            username: "",
            password: "",
        },
    });

    useEffect(() => {
        checkAllCommandsAvailability(dependencies).then((isAvailable) => {
            setIsCommandAvailable(isAvailable);
            setOpened(!isAvailable);
            setLoadingModal(false);
        });

        alertTimeout.current = setTimeout(() => setShowAlert(false), 5000);
        return () => alertTimeout.current && clearTimeout(alertTimeout.current);
    }, []);

    const handleProcessData = useCallback((data: string) => {
        setOutput((prev) => prev + "\n" + data);
    }, []);

    // âœ… FIXED & SAFE TERMINATION HANDLING
    const handleProcessTermination = useCallback(
        ({ code, signal }: { code: number; signal: number }) => {
            if (signal === 15) {
                handleProcessData("[!] Scan was manually terminated by the user.");
            } else if (code === 0) {
                handleProcessData("[+] Scan completed.");
                handleProcessData("[+] Scan finished. Please review the output above for details.");
            } else {
                handleProcessData(`[!] Scan failed with exit code ${code}.`);
                handleProcessData("[!] Please verify target details and try again.");
            }

            setPid("");
            setLoading(false);
            setAllowSave(true);
            setHasSaved(false);
        },
        [handleProcessData]
    );

    const onSubmit = (values: FormValuesType) => {
        if (customConfig && (!values.target || !values.port)) {
            setOutput("[!] Target IP and Port are required for manual configuration.");
            return;
        }

        setAllowSave(false);
        setLoading(true);
        setOutput("[+] Scan started...\n");

        const baseArgs = ["-s", values.plugin];
        const conditionalArgs: string[][] = [
            customConfig ? ["-t", values.target, "-p", values.port] : [],
            pluginsRequiringAuth.includes(selectedPlugin) || selectedPlugin === "SMTP"
                ? ["-u", selectedPlugin === "SMTP" ? values.email : values.username]
                : [],
            pluginsRequiringAuth.includes(selectedPlugin) ? ["-v", values.password] : [],
        ];

        const args = baseArgs.concat(conditionalArgs.filter(Boolean).flat());

        CommandHelper.runCommandGetPidAndOutput("bed", args, handleProcessData, handleProcessTermination)
            .then(({ pid }) => setPid(pid))
            .catch((error) => {
                setLoading(false);
                setOutput(`[!] Error: ${error.message}`);
            });
    };

    const clearOutput = () => {
        setOutput("");
        setAllowSave(false);
        setHasSaved(false);
    };

    return (
        <RenderComponent
            title="BEDTool"
            description="BED (Bruteforce Exploit Detector) scans network services for vulnerabilities."
            steps="1. Select plugin  2. Configure target  3. Click Scan"
            tutorial="https://docs.google.com/document/d/1BPzqMP5b9C9OjsJuIKXfxPyMxDd6oqUhrTvwi29fOKo/edit"
            sourceLink="https://www.kali.org/tools/bed/"
        >
            {!loadingModal && (
                <InstallationModal
                    isOpen={opened}
                    setOpened={setOpened}
                    feature_description="BED Tool"
                    dependencies={dependencies}
                />
            )}

            <form onSubmit={form.onSubmit(onSubmit)}>
                <Stack>
                    {showAlert && (
                        <Alert title="Warning" color="red">
                            Use this tool only on systems you own or have permission to test.
                        </Alert>
                    )}

                    {LoadingOverlayAndCancelButton(loading, pid)}

                    <Switch
                        label="Manual Network Configuration"
                        checked={customConfig}
                        onChange={(e) => setCustomConfig(e.currentTarget.checked)}
                    />

                    <Select
                        label="Plugin Type"
                        placeholder="Select plugin"
                        data={pluginList}
                        value={selectedPlugin}
                        onChange={(v) => {
                            setSelectedPlugin(v || "");
                            form.setFieldValue("plugin", v || "");
                        }}
                        required
                    />

                    {customConfig && (
                        <>
                            <TextInput label="Target IP" required {...form.getInputProps("target")} />
                            <TextInput label="Port" required {...form.getInputProps("port")} />
                        </>
                    )}

                    {SaveOutputToTextFile_v2(output, allowSave, hasSaved, () => setHasSaved(true))}

                    <Button type="submit">Scan</Button>

                    <ConsoleWrapper output={output} clearOutputCallback={clearOutput} pid={pid} loading={loading} />
                </Stack>
            </form>
        </RenderComponent>
    );
}

export default BEDTool;
